<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NEW: Tells browsers to respect our custom light/dark themes -->
    <meta name="color-scheme" content="light dark">
    <title>Door Configurator</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="header-controls">
            <div class="logo-container">
                <img src="your-logo.png" alt="Your Company Logo">
            </div>
            <div class="theme-switch-wrapper">
                <label class="theme-switch">
                    <input type="checkbox" id="theme-slider">
                    <span class="slider">
                        <span class="knob"></span>
                    </span>
                </label>
            </div>
        </div>
        
        <h1>Door Configurator</h1>

        <div class="configurator-wrapper">
            <div class="configurator-header">
                <h3>Options</h3>
                <button id="randomize-button" class="action-button">Surprise Me!</button>
            </div>
            <div class="configurator-main">
                <div class="progress-bar-container vertical">
                    <div class="progress-bar vertical" id="progress-bar"></div>
                </div>
                <div id="options-container"></div>
            </div>
            <button id="reset-button">Reset</button>
        </div>
        <div class="preview-wrapper">
            <h3>Preview</h3>
            <!-- <img id="door-image" src="https://via.placeholder.com/300x400.png?text=Select+Door" alt="Door preview"> -->
            <div id="result" class="result-box">
                <h3>Your Configuration:</h3>
                <p id="item-desc-result"></p>
                <p class="item-number" id="pro-stock-clickable">Pro Stock #: <span id="pro-stock-result"></span></p>
                <p class="item-number" id="current-stock-clickable">Current Stock #: <span id="current-stock-result"></span></p>
                <button id="share-button" class="action-button" style="margin-top: 15px; width: 100%;">Share This Configuration</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const optionsContainer = document.getElementById('options-container');
            const resultBox = document.getElementById('result');
            const proStockResult = document.getElementById('pro-stock-result');
            const currentStockResult = document.getElementById('current-stock-result');
            const itemDescResult = document.getElementById('item-desc-result');
            const doorImage = document.getElementById('door-image');
            const resetButton = document.getElementById('reset-button');
            const themeSlider = document.getElementById('theme-slider');
            const randomizeButton = document.getElementById('randomize-button');
            const shareButton = document.getElementById('share-button');
            const proStockClickable = document.getElementById('pro-stock-clickable');
            const currentStockClickable = document.getElementById('current-stock-clickable');
            const progressBar = document.getElementById('progress-bar');

            let csvData = [];
            
            const filterColumns = [
                'Program', 'Glass', 'Material', 'Core_Type', 'Style', 'Configuration', 'Finish_Texture',
                'Size_Width_in', 'Size_Height_in', 'Bore_Status', 'Handing', 'Jamb_Type',
                'Jamb_Casing', 'Hinge_Finish', 'Special_Features'
            ];

            themeSlider.addEventListener('change', () => {
                if (themeSlider.checked) {
                    document.body.classList.add('light-mode');
                    localStorage.setItem('theme', 'light-mode');
                } else {
                    document.body.classList.remove('light-mode');
                    localStorage.setItem('theme', 'dark-mode');
                }
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light-mode') {
                document.body.classList.add('light-mode');
                themeSlider.checked = true;
            }

            Papa.parse('CSV-Sheets/doors_final_with_descriptions.csv', {
                download: true,
                header: true,
                skipEmptyLines: true,
                transformHeader: header => header.trim(),
                complete: function(results) {
                    csvData = results.data;
                    initialize();
                }
            });
            
            function initialize() {
                optionsContainer.innerHTML = '';
                filterColumns.forEach((header, index) => {
                    const group = document.createElement('div');
                    group.className = 'option-group';
                    if (index > 0) group.classList.add('hidden');
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <svg class="checkmark" viewBox="0 0 24 24">
                            <path d="M4.5 12.75l6 6 9-13.5"/>
                        </svg>
                        <span>${header.replace(/_/g, ' ')}</span>
                    `;
                    const select = document.createElement('select');
                    select.id = `select-${index}`;
                    select.dataset.level = index;
                    select.dataset.header = header;
                    group.appendChild(label);
                    group.appendChild(select);
                    optionsContainer.appendChild(group);
                });
                
                optionsContainer.addEventListener('change', handleOptionChange);
                resetButton.addEventListener('click', resetAll);
                randomizeButton.addEventListener('click', selectRandomConfiguration);
                shareButton.addEventListener('click', copyShareLink);
                proStockClickable.addEventListener('click', () => {
                    const itemNumber = proStockResult.textContent;
                    copyToClipboard(itemNumber, "Pro Stock #");
                    if (itemNumber && itemNumber !== 'N/A') {
                        window.open(`https://www.lowes.com/search?searchTerm=${encodeURIComponent(itemNumber)}`, '_blank');
                    }
                });
                currentStockClickable.addEventListener('click', () => {
                    const itemNumber = currentStockResult.textContent;
                    copyToClipboard(itemNumber, "Current Stock #");
                    if (itemNumber && itemNumber !== 'N/A') {
                        window.open(`https://www.lowes.com/search?searchTerm=${encodeURIComponent(itemNumber)}`, '_blank');
                    }
                });
                
                // MutationObserver for options container
                const observer = new MutationObserver(() => {
                    updateProgressBar();
                });
                observer.observe(optionsContainer, { childList: true, subtree: true, attributes: true, attributeFilter: ['class', 'style'] });
                
                loadConfigFromURL();
            }

            function resetAll() {
                resultBox.classList.remove('visible');
                if (doorImage) doorImage.src = 'https://via.placeholder.com/300x400.png?text=Select+Door';

                document.querySelectorAll('.option-group:not(.hidden)').forEach((group, index) => {
                    if (index > 0) {
                       group.classList.add('hidden');
                    }
                });

                setTimeout(() => {
                    document.querySelectorAll('#options-container select').forEach(s => {
                        s.classList.remove('is-valid', 'needs-attention');
                    });
                    document.querySelectorAll('.option-group').forEach(g => g.classList.remove('is-valid'));
                    updateDropdown(0, csvData, true);
                    for (let i = 1; i < filterColumns.length; i++) {
                        const select = document.getElementById(`select-${i}`);
                        select.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.textContent = `Select a ${filterColumns[i-1].replace(/_/g, ' ')} first`;
                        select.appendChild(defaultOption);
                        select.disabled = true;
                    }
                    updateProgressBar();
                    // Scroll to top after reset logic completes
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 0);
                }, 400); 
            }
            
            function handleOptionChange(event) {
                const changedSelect = event.target;
                resultBox.classList.remove('visible');
                // Track the order in which selections are made
                if (!window.selectionOrder) window.selectionOrder = [];
                const selectId = changedSelect.id;
                if (!window.selectionOrder.includes(selectId)) {
                    window.selectionOrder.push(selectId);
                }
                // Remove any later selections if user changes an earlier one
                const changedIndex = window.selectionOrder.indexOf(selectId);
                window.selectionOrder = window.selectionOrder.slice(0, changedIndex + 1);

                // Build selections in the order picked
                const orderedSelections = {};
                window.selectionOrder.forEach(id => {
                    const select = document.getElementById(id);
                    if (!select.disabled && select.value && !select.options[select.selectedIndex].disabled) {
                        if (select.dataset.header === 'Glass' && select.value === 'No Glass') {
                            orderedSelections[select.dataset.header] = '';
                        } else {
                            orderedSelections[select.dataset.header] = select.value;
                        }
                    }
                });

                // Filter data strictly in order of selection
                let filteredData = csvData;
                Object.keys(orderedSelections).forEach(key => {
                    filteredData = filteredData.filter(row => row[key] === orderedSelections[key]);
                });

                // Update dropdowns for all columns after the last picked
                for (let i = 0; i < filterColumns.length; i++) {
                    // Only update dropdowns that haven't been picked yet
                    const select = document.getElementById(`select-${i}`);
                    if (!window.selectionOrder.includes(select.id)) {
                        updateDropdown(i, filteredData, false);
                    }
                }
                updateValidationStyles();
                checkAndDisplayResult();
                updateProgressBar();
                setTimeout(() => {
                    const nextGroup = Array.from(document.querySelectorAll('.option-group')).find(group => {
                        const select = group.querySelector('select');
                        return !select.disabled && (!select.value || select.selectedIndex === 0);
                    });
                    if (nextGroup) {
                        nextGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    setTimeout(updateProgressBar, 400);
                }, 200);
            }
            
            function updateDropdown(level, data, forceReset) {
                const select = document.getElementById(`select-${level}`);
                const group = select.closest('.option-group');
                const header = select.dataset.header;
                const oldValue = select.value;
                const wasPreviouslySelected = oldValue && select.selectedIndex > 0;


                let uniqueOptions;
                if (header === 'Glass') {
                    // Only show glass options that exist for the current filtered data
                    uniqueOptions = [...new Set(data.map(row => row['Glass'] && row['Glass'].trim() !== '' ? row['Glass'] : 'No Glass'))];
                } else {
                    uniqueOptions = [...new Set(data.map(row => row[header]).filter(val => val && val.trim() !== ''))];
                }
                uniqueOptions = uniqueOptions.sort((a,b) => isNaN(a) || isNaN(b) ? a.localeCompare(b, undefined, {numeric: true}) : a - b);

                select.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.textContent = `Select a ${header.replace(/_/g, ' ')}`;
                defaultOption.disabled = true;
                select.appendChild(defaultOption);

                uniqueOptions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    select.appendChild(option);
                });

                select.classList.remove('is-valid', 'needs-attention');
                group.classList.remove('is-valid');

                if (uniqueOptions.length === 0) {
                    select.selectedIndex = 0;
                    defaultOption.textContent = "Not Applicable";
                    select.disabled = true;
                    group.classList.add('hidden');
                } else {
                    select.disabled = false;
                    group.classList.remove('hidden');
                    // For Glass dropdown, auto-select 'No Glass' if it's the only valid option for this data
                    if (header === 'Glass' && uniqueOptions.includes('No Glass') && uniqueOptions.length === 1) {
                        select.value = 'No Glass';
                        select.classList.add('is-valid');
                        group.classList.add('is-valid');
                    } else if (uniqueOptions.length === 1) {
                        select.selectedIndex = 1;
                        select.classList.add('is-valid');
                        group.classList.add('is-valid');
                    } else if (uniqueOptions.includes(oldValue) && !forceReset) {
                        select.value = oldValue;
                        select.classList.add('is-valid');
                        group.classList.add('is-valid');
                    } else {
                        select.selectedIndex = 0;
                        if (wasPreviouslySelected) {
                            select.classList.add('needs-attention');
                        }
                    }
                }
            }

            function getSelections(maxLevel = filterColumns.length - 1) {
                const selections = {};
                for (let i = 0; i <= maxLevel; i++) {
                    const select = document.getElementById(`select-${i}`);
                    if (!select.disabled && select.value && !select.options[select.selectedIndex].disabled) {
                        // For Glass dropdown, treat 'No Glass' as empty string for filtering
                        if (select.dataset.header === 'Glass' && select.value === 'No Glass') {
                            selections[select.dataset.header] = '';
                        } else {
                            selections[select.dataset.header] = select.value;
                        }
                    }
                }
                return selections;
            }

            function updateValidationStyles() {
                for (let i = 0; i < filterColumns.length; i++) {
                    const select = document.getElementById(`select-${i}`);
                    const group = select.closest('.option-group');
                    const hasSelection = select.value && !select.options[select.selectedIndex].disabled;
                    // Remove all state classes first
                    select.classList.remove('is-valid', 'needs-attention');
                    group.classList.remove('is-valid');
                    if (hasSelection) {
                        // Green for valid
                        select.classList.add('is-valid');
                        group.classList.add('is-valid');
                    } else if (select.selectedIndex > 0) {
                        // Red for needs attention (was previously selected but now invalid)
                        select.classList.add('needs-attention');
                    }
                    // White is default, no class needed
                }
                updateProgressBar();
            }

            function checkAndDisplayResult() {
                const selections = getSelections();
                const activeDropdowns = document.querySelectorAll('#options-container select:not(:disabled)');
                if (Object.keys(selections).length > 0 && Object.keys(selections).length === activeDropdowns.length) {
                    const foundRow = csvData.find(row => Object.keys(selections).every(key => row[key] === selections[key]));
                    if (foundRow) {
                        let style = foundRow["Style"] ? foundRow["Style"] : "Door";
                        let title = style;
                        if (foundRow["Size_Width_in"] && foundRow["Size_Height_in"]) {
                            title = `${style} ${foundRow["Size_Width_in"]}in x ${foundRow["Size_Height_in"]}in`;
                        }
                        itemDescResult.innerHTML = `<strong>${title}</strong><br>${foundRow["Original_Description"] || 'N/A'}`;
                        proStockResult.textContent = foundRow["Lowe's_Pro_Stock_Item_Number"] || 'N/A';
                        let currentStock = foundRow["Current_Stock_Item_Number"];
                        if (currentStock && currentStock.endsWith('.0')) {
                            currentStock = currentStock.slice(0, -2);
                        } else if (typeof currentStock === 'number') {
                            currentStock = currentStock % 1 === 0 ? currentStock.toString().replace(/\.0$/, '') : currentStock.toString();
                        }
                        currentStockResult.textContent = currentStock || 'N/A';
                        resultBox.classList.add('visible');
                        // Auto-scroll to Preview panel
                        setTimeout(() => {
                            const previewPanel = document.querySelector('.preview-wrapper');
                            if (previewPanel) {
                                previewPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 300);
                    }
                }
            }

            function updateProgressBar() {
                const activeDropdowns = document.querySelectorAll('#options-container select:not(:disabled)');
                const selectedActiveDropdowns = document.querySelectorAll('#options-container select.is-valid:not(:disabled)');
                const progress = activeDropdowns.length > 0 ? (selectedActiveDropdowns.length / activeDropdowns.length) * 100 : 0;
                const container = document.querySelector('.progress-bar-container.vertical');
                const options = document.getElementById('options-container');
                if (container && options) {
                    const fullHeight = options.scrollHeight;
                    container.style.height = fullHeight + 'px';
                    progressBar.style.height = `${(progress/100)*fullHeight}px`;
                }
            }

            function selectRandomConfiguration() {
                resetAll();
                setTimeout(() => {
                    const validDoors = csvData.filter(row => row.Program !== 'Component');
                    if (validDoors.length === 0) return;
                    const randomRow = validDoors[Math.floor(Math.random() * validDoors.length)];
                    let filteredData = csvData;
                    for (let i = 0; i < filterColumns.length; i++) {
                        const header = filterColumns[i];
                        let valueToSet = randomRow[header];
                        // For Glass dropdown, treat empty string as 'No Glass'
                        if (header === 'Glass' && (!valueToSet || valueToSet.trim() === '')) {
                            valueToSet = 'No Glass';
                        }
                        updateDropdown(i, filteredData, true);
                        const select = document.getElementById(`select-${i}`);
                        if (valueToSet && !select.disabled) {
                            select.value = valueToSet;
                        }
                        const selections = getSelections(i);
                        filteredData = csvData.filter(row => Object.keys(selections).every(key => {
                            if (key === 'Glass' && selections[key] === 'No Glass') {
                                return !row['Glass'] || row['Glass'].trim() === '';
                            }
                            return row[key] === selections[key];
                        }));
                    }
                    updateValidationStyles();
                    checkAndDisplayResult();
                    // Ensure progress bar updates after all dropdowns are set
                    setTimeout(updateProgressBar, 400);
                    // Scroll to bottom so user can see the configuration and reset button
                    setTimeout(() => {
                        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    }, 700);
                }, 450);
            }

            function copyShareLink() {
                const selections = getSelections();
                if (Object.keys(selections).length === 0) return;
                const params = new URLSearchParams();
                for (const key in selections) {
                    params.append(key, selections[key]);
                }
                const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                copyToClipboard(shareUrl, "Shareable link");
            }

            function copyToClipboard(text, type) {
                if (!text || text === 'N/A') return;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        showInlineCopyFeedback(type);
                    }).catch(() => {
                        showInlineCopyFeedback(type, true);
                    });
                } else {
                    // Fallback for older browsers
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        const success = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (success) {
                            showInlineCopyFeedback(type);
                        } else {
                            showInlineCopyFeedback(type, true);
                        }
                    } catch {
                        showInlineCopyFeedback(type, true);
                    }
                }
            }

            function showInlineCopyFeedback(type, failed = false) {
                let target, span, originalText;
                const msg = failed ? "Copy failed" : "Copied to clipboard!";
                if (type === "Pro Stock #") {
                    target = proStockClickable;
                    span = document.getElementById('pro-stock-result');
                    originalText = span.textContent;
                    target.classList.add('copied-inline');
                    target.innerHTML = `<span style="font-weight:bold;">${msg}</span>`;
                } else if (type === "Current Stock #") {
                    target = currentStockClickable;
                    span = document.getElementById('current-stock-result');
                    originalText = span.textContent;
                    target.classList.add('copied-inline');
                    target.innerHTML = `<span style="font-weight:bold;">${msg}</span>`;
                } else if (type === "Shareable link") {
                    target = document.getElementById('share-button');
                    originalText = target.textContent;
                    target.classList.add('copied-inline');
                    target.textContent = msg;
                }
                setTimeout(() => {
                    if (type === "Pro Stock #") {
                        target.classList.remove('copied-inline');
                        target.innerHTML = `Pro Stock #: <span id="pro-stock-result">${originalText}</span>`;
                    } else if (type === "Current Stock #") {
                        target.classList.remove('copied-inline');
                        target.innerHTML = `Current Stock #: <span id="current-stock-result">${originalText}</span>`;
                    } else if (type === "Shareable link") {
                        target.classList.remove('copied-inline');
                        target.textContent = "Share This Configuration";
                    }
                }, 1400);
            }

            function loadConfigFromURL() {
                const params = new URLSearchParams(window.location.search);
                if (params.toString() === '') {
                    resetAll();
                    return;
                }
                let filteredData = csvData;
                for (let i = 0; i < filterColumns.length; i++) {
                    const header = filterColumns[i];
                    let value = params.get(header);
                    updateDropdown(i, filteredData, false);
                    const select = document.getElementById(`select-${i}`);
                    // Special handling for Glass: empty string in URL means 'No Glass' in dropdown
                    if (header === 'Glass' && (value === '' || value === null)) {
                        value = 'No Glass';
                    }
                    if (value && Array.from(select.options).some(opt => opt.value === value)) {
                        select.value = value;
                        const selections = getSelections(i);
                        filteredData = csvData.filter(row => Object.keys(selections).every(key => row[key] === selections[key]));
                    } else {
                        break;
                    }
                }
                updateValidationStyles();
                checkAndDisplayResult();
            }

            window.addEventListener('resize', () => {
                const canvas = document.getElementById('confetti-canvas');
                if (canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            });
        }); // <-- End of DOMContentLoaded handler
    </script>
</body>
</html>

    </script>
</body>
</html>
</html>
